<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<title>DATA STOCK VERIMARK</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

<style>

body{
font-family:'Montserrat',sans-serif;
background:url('bgweb.png') center/cover fixed;
color:white;
text-align:center;
padding:20px;
}

.main-box{
background:rgba(255,255,255,0.08);
padding:25px;
border-radius:15px;
max-width:1100px;
margin:auto;
box-shadow:0 0 30px purple;
}

table{
width:100%;
background:white;
color:black;
border-collapse:collapse;
}

th,td{
padding:10px;
border-bottom:1px solid #ddd;
}

button{
padding:6px 12px;
background:#6a0dad;
color:white;
border:none;
border-radius:6px;
cursor:pointer;
}

button:hover{
background:#7d27c1;
}

/* MODAL FORM */

.modal{
display:none;
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:rgba(0,0,0,0.7);
}

.modal-content{
background:white;
color:black;
padding:20px;
margin:8% auto;
width:350px;
border-radius:10px;
}

input{
width:100%;
padding:8px;
margin:6px 0;
}

#loadingOverlay{
  position: fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background: rgba(0,0,0,0.6);
  display:none;
  justify-content:center;
  align-items:center;
  flex-direction:column;
  z-index:9999;
  color:white;
  font-family:Arial;
}

/* SPINNER */
.loader{
  border:6px solid #f3f3f3;
  border-top:6px solid #8a2be2;
  border-radius:50%;
  width:60px;
  height:60px;
  animation:spin 1s linear infinite;
  margin-bottom:10px;
}

@keyframes spin{
  0%{transform:rotate(0deg);}
  100%{transform:rotate(360deg);}
}

</style>
</head>

<body>

<div class="main-box">

<h2>DATA STOCK VERIMARK</h2>

<table>
<thead>
<tr>
<th>NO</th>
<th>KODE</th>
<th>NAMA</th>
<th>QTY</th>
<th>IN</th>
<th>OUT</th>
</tr>
</thead>

<tbody id="stokBody"></tbody>
</table>

</div>

<!-- MODAL -->
<div id="formModal" class="modal">
<div class="modal-content">

<h3 id="formTitle"></h3>

<input id="tanggal" placeholder="Tanggal">
<input id="kode">
<input id="nama">
<input id="qty" type="number">
<input id="extra1">
<input id="extra2">

<button onclick="submitForm()">Submit</button>

</div>
</div>

<script>
function showLoading(){
  document.getElementById("loadingOverlay").style.display="flex";
}

function hideLoading(){
  document.getElementById("loadingOverlay").style.display="none";
}

/* ===== API GOOGLE SHEET ===== */
const API_URL="https://script.google.com/macros/s/AKfycbzY7g-RaDaWKoN7CVcpUp8UsCP_HaYSBBfzr2aiTRVaO5I_hRW0GR649RAYr6gG0Fh-/exec";
/* ===== DATA SAMPLE ===== */
let spareparts=[];

let mode="";
let activeIndex=null;

const tbody=document.getElementById("stokBody");

function render(){

tbody.innerHTML="";

spareparts.forEach((sp,i)=>{

tbody.innerHTML+=`
<tr>
<td>${i+1}</td>
<td>${sp.kode}</td>
<td>${sp.nama}</td>
<td id="qty-${i}">${sp.qty}</td>

<td>
<button onclick="openForm('IN',${i})">IN</button>
</td>

<td>
<button onclick="openForm('OUT',${i})">OUT</button>
</td>

</tr>
`;

});

}

render();

function resetForm(){
document.getElementById("tanggal").value="";
document.getElementById("qty").value="";
document.getElementById("extra1").value="";
document.getElementById("extra2").value="";
document.getElementById("extra2").style.display="block";
}

/* OPEN FORM */

function openForm(type,index){

resetForm();

mode=type;
activeIndex=index;

document.getElementById("formModal").style.display="block";

document.getElementById("kode").value=spareparts[index].kode;
document.getElementById("nama").value=spareparts[index].nama;

if(type==="IN"){
document.getElementById("formTitle").innerText="FORM IN";
document.getElementById("extra1").placeholder="NO RPO";
document.getElementById("extra2").placeholder="NO PL";
}else{
document.getElementById("formTitle").innerText="FORM OUT";
document.getElementById("extra1").placeholder="NO SPB";
document.getElementById("extra2").style.display="none";
}

}

/* LOAD STOCK FROM SHEET */
async function loadStock(){

let res=await fetch(API_URL+"?sheet=STOK_VERIMARK");

let data=await res.json();

data.shift();

spareparts=data.map(r=>({
kode:r[1],
nama:r[2],
qty:Number(r[3])
}));

render();
}

loadStock();


/* SUBMIT FORM */
async function submitForm(){

let tanggal=document.getElementById("tanggal").value;
let kode=document.getElementById("kode").value;
let nama=document.getElementById("nama").value;
let qty=parseInt(document.getElementById("qty").value);

let extra1=document.getElementById("extra1").value;
let extra2=document.getElementById("extra2").value;

if(!qty || qty<=0){
alert("Qty tidak valid");
return;
}

/* ===== BUAT PAYLOAD ===== */

let payload;

if(mode==="IN"){
payload=["",tanggal,kode,nama,qty,extra1,extra2];
}

if(mode==="OUT"){
payload=["",tanggal,kode,nama,qty,extra1];
}

/* ===== KIRIM KE GOOGLE SHEET ===== */
showLoading();

await fetch(API_URL+"?sheet="+
(mode==="IN"?"IN_VERIMARK":"OUT_VERIMARK"),{
method:"POST",
body:JSON.stringify(payload)
});

/* ===== RELOAD DATA DARI SERVER ===== */

await loadStock();

document.getElementById("formModal").style.display="none";

setTimeout(()=>{
  hideLoading();
  alert("Data berhasil tersimpan!");
},800);
}

window.onclick=function(e){
let modal=document.getElementById("formModal");
if(e.target==modal){
modal.style.display="none";
}
}

</script>

<!-- LOADING OVERLAY -->
<div id="loadingOverlay">
  <div class="loader"></div>
  <p>Processing data...</p>
</div>

</body>
</html>
